import hudson.EnvVars;
import hudson.slaves.EnvironmentVariablesNodeProperty;
import hudson.slaves.NodeProperty;
import hudson.slaves.NodePropertyDescriptor;
import hudson.util.DescribableList;
import jenkins.model.Jenkins;

node {
 // def mvnHome = tool name: 'M2_HOME', type: 'maven'
 def branch = env.NEXT_BRANCH_NAME
 def newVersion
 // Asking user if he wants to promote the code to QA, user will choose either proceed or abort
 stage('checkout') {
  input 'Do you want to promote the code to QA?'
  dir(branch) {
   checkout([$class: 'GitSCM',
    branches: [
     [name: branch]
    ],
    extensions: scm.extensions + [[$class: 'CleanCheckout']],
    userRemoteConfigs: [
     [url: 'git@github.com:mosip/mosip-configuration.git', credentialsId: 'fd9c5f45-e6ac-45ea-b345-f6fbeb303044']
    ]
   ])
  }
 }
  stage('GIT - Push the code and Create new tag') {
  dir(branch) {
      // jenkins git plugin detaches the head after checking out the code, stashing the changes to check out branch code
	  sh "git stash"
	  // checking out branch
	  sh "git checkout $branch"
	  // applying stashed changes to branch
	  sh "git stash apply"  
	  sh "git add ."
	  // clearing the stash
	  sh "git stash clear"
	  // commiting changes to branch
	  sh "git commit -m 'MOS-14569 updating versions and tagging the code for giving it to QA'"
      sshagent(['fd9c5f45-e6ac-45ea-b345-f6fbeb303044']) {
       sh "git push origin $branch"
      }
      // creating a git tag
      sh "git tag ${newVersion}"
	  // pushing tag to github
      sshagent(['fd9c5f45-e6ac-45ea-b345-f6fbeb303044']) {
      sh "git push origin ${newVersion}"
      }
 
  }
  // Clean the workspace to avoid GIT conflicts when next time this pipeline is triggered
  	cleanWs()
 } 
}
