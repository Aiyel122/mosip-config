import hudson.EnvVars;
import hudson.slaves.EnvironmentVariablesNodeProperty;
import hudson.slaves.NodeProperty;
import hudson.slaves.NodePropertyDescriptor;
import hudson.util.DescribableList;
import jenkins.model.Jenkins;

node {
 def mvnHome = tool name: 'M2_HOME', type: 'maven'
 def branch = 'master'
 def newVersion = env.NEXT_BRANCH_NAME
 // Asking user if he wants to start a new sprint, user will choose either proceed or abort
 stage('checkout') {
  input 'Do you want to start a new Sprint?'
  dir(branch) {
   checkout([$class: 'GitSCM',
    branches: [
     [name: branch]
    ],
    userRemoteConfigs: [
     [url: 'git@github.com:mosip/mosip-configuration.git', credentialsId: 'fd9c5f45-e6ac-45ea-b345-f6fbeb303044']
    ]
   ])
  }
 }
stage('GIT - Create new branch') {
  dir(branch) {
   sh "git checkout -b ${newVersion}"
   sh "git add ."
   sh "git commit -m 'new branch created'"

   sshagent(['fd9c5f45-e6ac-45ea-b345-f6fbeb303044']) {
    sh "git push origin ${newVersion}"
   }
  }

 // Setting global environment variable for Branch name
	echo "Setting global variable NEXT_BRANCH_NAME to "+newVersion
	createGlobalEnvironmentVariables("NEXT_BRANCH_NAME",newVersion)
 } 

}



// function which will configure Jenkins global variable
public createGlobalEnvironmentVariables(String key, String value) {

 Jenkins instance = Jenkins.getInstance();

 DescribableList < NodeProperty <?> , NodePropertyDescriptor > globalNodeProperties = instance.getGlobalNodeProperties();
 List < EnvironmentVariablesNodeProperty > envVarsNodePropertyList = globalNodeProperties.getAll(EnvironmentVariablesNodeProperty.class);

 EnvironmentVariablesNodeProperty newEnvVarsNodeProperty = null;
 EnvVars envVars = null;

 if (envVarsNodePropertyList == null || envVarsNodePropertyList.size() == 0) {
  newEnvVarsNodeProperty = new hudson.slaves.EnvironmentVariablesNodeProperty();
  globalNodeProperties.add(newEnvVarsNodeProperty);
  envVars = newEnvVarsNodeProperty.getEnvVars();
 } else {
  envVars = envVarsNodePropertyList.get(0).getEnvVars();
 }
 envVars.put(key, value)
 instance.save()
}
